FROM mcr.microsoft.com/dotnet/sdk:9.0

WORKDIR /app

# ═══════════════════════════════════════════════════════════════
# Dependencias del sistema (LibreOffice + Chromium deps)
# ═══════════════════════════════════════════════════════════════
RUN apt-get update && \
    apt-get install -y \
        libreoffice libreoffice-writer \
        libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
        libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 \
        libpango-1.0-0 libcairo2 libasound2 libxshmfence1 \
        wget curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ═══════════════════════════════════════════════════════════════
# .NET restore + build
# ═══════════════════════════════════════════════════════════════
COPY ["Inmobiscrap.csproj", "./"]
RUN dotnet restore "Inmobiscrap.csproj"

RUN dotnet tool install --global dotnet-ef --version 9.0.0
ENV PATH="${PATH}:/root/.dotnet/tools"

COPY . .
RUN dotnet build "Inmobiscrap.csproj" -c Debug

# ═══════════════════════════════════════════════════════════════
# INSTALAR PLAYWRIGHT BROWSERS (solo Chromium, lo demás no se usa)
# Usa pwsh que viene incluido en el SDK de .NET
# ═══════════════════════════════════════════════════════════════
RUN pwsh /app/bin/Debug/net9.0/playwright.ps1 install chromium --with-deps && \
    echo "✅ Playwright OK:" && ls /root/.cache/ms-playwright/

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 8080
ENTRYPOINT ["/entrypoint.sh"]
